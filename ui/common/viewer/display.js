import * as THREE from './three.min'; import $ from "jquery"; var BP3D;!function(t){var e;!function(t){var e=function(){function t(){}return t.pointDistanceFromLine=function(e,o,n,i,r,s){var a=t.closestPointOnLine(e,o,n,i,r,s),l=e-a.x,c=o-a.y;return Math.sqrt(l*l+c*c)},t.closestPointOnLine=function(t,e,o,n,i,r){var s,a,l=t-o,c=e-n,h=i-o,u=r-n,d=l*h+c*u,f=h*h+u*u,p=d/f;return 0>p||o==i&&n==r?(s=o,a=n):p>1?(s=i,a=r):(s=o+p*h,a=n+p*u),{x:s,y:a}},t.distance=function(t,e,o,n){return Math.sqrt(Math.pow(o-t,2)+Math.pow(n-e,2))},t.angle=function(t,e,o,n){var i=t*o+e*n,r=t*n-e*o,s=-Math.atan2(r,i);return s},t.angle2pi=function(e,o,n,i){var r=t.angle(e,o,n,i);return 0>r&&(r+=2*Math.PI),r},t.isClockwise=function(e){for(var o=Math.min(0,Math.min.apply(null,t.map(e,function(t){return t.x}))),n=Math.min(0,Math.min.apply(null,t.map(e,function(t){return t.x}))),i=t.map(e,function(t){return{x:t.x-o,y:t.y-n}}),r=0,s=0;s<i.length;s++){var a,l=i[s];a=s==i.length-1?i[0]:i[s+1],r+=(a.x-l.x)*(a.y+l.y)}return r>=0},t.guid=function(){var t=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},t.polygonPolygonIntersect=function(e,o){for(var n=0;n<e.length;n++){var i,r=e[n];if(i=n==e.length-1?e[0]:e[n+1],t.linePolygonIntersect(r.x,r.y,i.x,i.y,o))return!0}return!1},t.linePolygonIntersect=function(e,o,n,i,r){for(var s=0;s<r.length;s++){var a,l=r[s];if(a=s==r.length-1?r[0]:r[s+1],t.lineLineIntersect(e,o,n,i,l.x,l.y,a.x,a.y))return!0}return!1},t.lineLineIntersect=function(t,e,o,n,i,r,s,a){function l(t,e,o){var n=t.x,i=t.y,r=e.x,s=e.y,a=o.x,l=o.y;return(l-i)*(r-n)>(s-i)*(a-n)}var c={x:t,y:e},h={x:o,y:n},u={x:i,y:r},d={x:s,y:a};return l(c,u,d)!=l(h,u,d)&&l(c,h,u)!=l(c,h,d)},t.pointInPolygon=function(e,o,n,i,r){i=i||0,r=r||0;var s=0,a=0;if(void 0===i||void 0===r){for(var l=0;l<n.length;l++)s=Math.min(s,n[l].x),a=Math.min(s,n[l].y);i=s-10,r=a-10}for(var c=0,l=0;l<n.length;l++){var h,u=n[l];h=l==n.length-1?n[0]:n[l+1],t.lineLineIntersect(i,r,e,o,u.x,u.y,h.x,h.y)&&c++}return c%2==1},t.polygonInsidePolygon=function(e,o,n,i){n=n||0,i=i||0;for(var r=0;r<e.length;r++)if(!t.pointInPolygon(e[r].x,e[r].y,o,n,i))return!1;return!0},t.polygonOutsidePolygon=function(e,o,n,i){n=n||0,i=i||0;for(var r=0;r<e.length;r++)if(t.pointInPolygon(e[r].x,e[r].y,o,n,i))return!1;return!0},t.forEach=function(t,e){for(var o=0;o<t.length;o++)e(t[o])},t.forEachIndexed=function(t,e){for(var o=0;o<t.length;o++)e(o,t[o])},t.map=function(t,e){var o=[];return t.forEach(function(t){o.push(e(t))}),o},t.removeIf=function(t,e){var o=[];return t.forEach(function(t){e(t)||o.push(t)}),o},t.cycle=function(t,e){for(var o=t.slice(0),n=0;e>n;n++){var i=o.shift();o.push(i)}return o},t.unique=function(t,e){for(var o=[],n={},i=0;i<t.length;i++)n.hasOwnProperty(t[i])||(o.push(t[i]),n[e(t[i])]=!0);return o},t.removeValue=function(t,e){for(var o=t.length-1;o>=0;o--)t[o]===e&&t.splice(o,1)},t.subtract=function(e,o){return t.removeIf(e,function(e){return t.hasValue(o,e)})},t.hasValue=function(t,e){for(var o=0;o<t.length;o++)if(t[o]===e)return!0;return!1},t}();t.Utils=e}(e=t.Core||(t.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.dimInch="inch",t.dimMeter="m",t.dimCentiMeter="cm",t.dimMilliMeter="mm";var e=function(){function e(){}return e.cmToMeasure=function(e){switch(t.Configuration.getStringValue(t.configDimUnit)){case t.dimInch:var o=.3937*e/12,n=Math.floor(o),i=Math.round(12*(o-n));return n+"'"+i+'"';case t.dimMilliMeter:return""+Math.round(10*e)+" mm";case t.dimCentiMeter:return""+Math.round(10*e)/10+" cm";case t.dimMeter:default:return""+Math.round(10*e)/1e3+" m"}},e}();t.Dimensioning=e}(e=t.Core||(t.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.configDimUnit="dimUnit",t.configWallHeight="wallHeight",t.configWallThickness="wallThickness";var e=function(){function e(){}return e.setValue=function(t,e){this.data[t]=e},e.getStringValue=function(e){switch(e){case t.configDimUnit:return this.data[e];default:throw Error("Invalid string configuration parameter: "+e)}},e.getNumericValue=function(e){switch(e){case t.configWallHeight:case t.configWallThickness:return this.data[e];default:throw Error("Invalid numeric configuration parameter: "+e)}},e.data={dimUnit:t.dimInch,wallHeight:250,wallThickness:10},e}();t.Configuration=e}(e=t.Core||(t.Core={}))}(BP3D||(BP3D={}));var __extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},BP3D;!function(t){var e;!function(e){var o=function(e){function o(t,o,n,i,r,s,a){e.call(this),this.model=t,this.metadata=o,this.errorGlow=new THREE.Mesh,this.hover=!1,this.selected=!1,this.highlighted=!1,this.error=!1,this.emissiveColor=4473924,this.errorColor=16711680,this.obstructFloorMoves=!0,this.allowRotate=!0,this.fixed=!1,this.dragOffset=new THREE.Vector3,this.getHeight=function(){return 2*this.halfSize.y},this.getWidth=function(){return 2*this.halfSize.x},this.getDepth=function(){return 2*this.halfSize.z},this.initObject=function(){this.placeInRoom(),this.scene.needsUpdate=!0},this.scene=this.model.scene,this.geometry=n,this.material=i,this.errorColor=16711680,this.resizable=o.resizable,this.castShadow=!0,this.receiveShadow=!1,this.geometry=n,this.material=i,r?(this.position.copy(r),this.position_set=!0):this.position_set=!1,this.geometry.computeBoundingBox(),this.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(-.5*(this.geometry.boundingBox.max.x+this.geometry.boundingBox.min.x),-.5*(this.geometry.boundingBox.max.y+this.geometry.boundingBox.min.y),-.5*(this.geometry.boundingBox.max.z+this.geometry.boundingBox.min.z))),this.geometry.computeBoundingBox(),this.halfSize=this.objectHalfSize(),s&&(this.rotation.y=s),null!=a&&this.setScale(a.x,a.y,a.z)}return __extends(o,e),o.prototype.remove=function(){this.scene.removeItem(this)},o.prototype.resize=function(t,e,o){var n=e/this.getWidth(),i=t/this.getHeight(),r=o/this.getDepth();this.setScale(n,i,r)},o.prototype.setScale=function(t,e,o){var n=new THREE.Vector3(t,e,o);this.halfSize.multiply(n),n.multiply(this.scale),this.scale.set(n.x,n.y,n.z),this.resized(),this.scene.needsUpdate=!0},o.prototype.setFixed=function(t){this.fixed=t},o.prototype.removed=function(){},o.prototype.updateHighlight=function(){var t=this.hover||this.selected;this.highlighted=t;var e=t?this.emissiveColor:0;this.material.materials.forEach(function(t){t.emissive.setHex(e)})},o.prototype.mouseOver=function(){this.hover=!0,this.updateHighlight()},o.prototype.mouseOff=function(){this.hover=!1,this.updateHighlight()},o.prototype.setSelected=function(){this.selected=!0,this.updateHighlight()},o.prototype.setUnselected=function(){this.selected=!1,this.updateHighlight()},o.prototype.clickPressed=function(t){this.dragOffset.copy(t.point).sub(this.position)},o.prototype.clickDragged=function(t){t&&this.moveToPosition(t.point.sub(this.dragOffset),t)},o.prototype.rotate=function(e){if(e){for(var o=t.Core.Utils.angle(0,1,e.point.x-this.position.x,e.point.z-this.position.z),n=Math.PI/16,i=-4;4>=i;i++)if(Math.abs(o-i*(Math.PI/2))<n){o=i*(Math.PI/2);break}this.rotation.y=o}},o.prototype.moveToPosition=function(t){this.position.copy(t)},o.prototype.clickReleased=function(){this.error&&this.hideError()},o.prototype.customIntersectionPlanes=function(){return[]},o.prototype.getCorners=function(t,e,o){o=o||this.position;var n=this.halfSize.clone(),i=new THREE.Vector3(-n.x,0,-n.z),r=new THREE.Vector3(n.x,0,-n.z),s=new THREE.Vector3(n.x,0,n.z),a=new THREE.Vector3(-n.x,0,n.z),l=new THREE.Matrix4;l.makeRotationY(this.rotation.y),i.applyMatrix4(l),r.applyMatrix4(l),s.applyMatrix4(l),a.applyMatrix4(l),i.add(o),r.add(o),s.add(o),a.add(o);var c=[{x:i.x,y:i.z},{x:r.x,y:r.z},{x:s.x,y:s.z},{x:a.x,y:a.z}];return c},o.prototype.showError=function(t){t=t||this.position,this.error||(this.error=!0,this.errorGlow=this.createGlow(this.errorColor,.8,!0),this.scene.add(this.errorGlow)),this.errorGlow.position.copy(t)},o.prototype.hideError=function(){this.error&&(this.error=!1,this.scene.remove(this.errorGlow))},o.prototype.objectHalfSize=function(){var t=new THREE.Box3;return t.setFromObject(this),t.max.clone().sub(t.min).divideScalar(2)},o.prototype.createGlow=function(t,e,o){o=o||!1,e=e||.2;var n=new THREE.MeshBasicMaterial({color:t,blending:THREE.AdditiveBlending,opacity:.2,transparent:!0,depthTest:!o}),i=new THREE.Mesh(this.geometry.clone(),n);return i.position.copy(this.position),i.rotation.copy(this.rotation),i.scale.copy(this.scale),i},o}(THREE.Mesh);e.Item=o}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=20,n=function(){function e(e,o,n,i){this.floorplan=e,this.x=o,this.y=n,this.id=i,this.wallStarts=[],this.wallEnds=[],this.moved_callbacks=$.Callbacks(),this.deleted_callbacks=$.Callbacks(),this.action_callbacks=$.Callbacks(),this.id=i||t.Core.Utils.guid()}return e.prototype.fireOnMove=function(t){this.moved_callbacks.add(t)},e.prototype.fireOnDelete=function(t){this.deleted_callbacks.add(t)},e.prototype.fireOnAction=function(t){this.action_callbacks.add(t)},e.prototype.getX=function(){return this.x},e.prototype.getY=function(){return this.y},e.prototype.snapToAxis=function(t){var e={x:!1,y:!1},o=this;return this.adjacentCorners().forEach(function(n){Math.abs(n.x-o.x)<t&&(o.x=n.x,e.x=!0),Math.abs(n.y-o.y)<t&&(o.y=n.y,e.y=!0)}),e},e.prototype.relativeMove=function(t,e){this.move(this.x+t,this.y+e)},e.prototype.fireAction=function(t){this.action_callbacks.fire(t)},e.prototype.remove=function(){this.deleted_callbacks.fire(this)},e.prototype.removeAll=function(){for(var t=0;t<this.wallStarts.length;t++)this.wallStarts[t].remove();for(var t=0;t<this.wallEnds.length;t++)this.wallEnds[t].remove();this.remove()},e.prototype.move=function(t,e){this.x=t,this.y=e,this.mergeWithIntersected(),this.moved_callbacks.fire(this.x,this.y),this.wallStarts.forEach(function(t){t.fireMoved()}),this.wallEnds.forEach(function(t){t.fireMoved()})},e.prototype.adjacentCorners=function(){for(var t=[],e=0;e<this.wallStarts.length;e++)t.push(this.wallStarts[e].getEnd());for(var e=0;e<this.wallEnds.length;e++)t.push(this.wallEnds[e].getStart());return t},e.prototype.isWallConnected=function(t){for(var e=0;e<this.wallStarts.length;e++)if(this.wallStarts[e]==t)return!0;for(var e=0;e<this.wallEnds.length;e++)if(this.wallEnds[e]==t)return!0;return!1},e.prototype.distanceFrom=function(e,o){var n=t.Core.Utils.distance(e,o,this.x,this.y);return n},e.prototype.distanceFromWall=function(t){return t.distanceFrom(this.x,this.y)},e.prototype.distanceFromCorner=function(t){return this.distanceFrom(t.x,t.y)},e.prototype.detachWall=function(e){t.Core.Utils.removeValue(this.wallStarts,e),t.Core.Utils.removeValue(this.wallEnds,e),0==this.wallStarts.length&&0==this.wallEnds.length&&this.remove()},e.prototype.attachStart=function(t){this.wallStarts.push(t)},e.prototype.attachEnd=function(t){this.wallEnds.push(t)},e.prototype.wallTo=function(t){for(var e=0;e<this.wallStarts.length;e++)if(this.wallStarts[e].getEnd()===t)return this.wallStarts[e];return null},e.prototype.wallFrom=function(t){for(var e=0;e<this.wallEnds.length;e++)if(this.wallEnds[e].getStart()===t)return this.wallEnds[e];return null},e.prototype.wallToOrFrom=function(t){return this.wallTo(t)||this.wallFrom(t)},e.prototype.combineWithCorner=function(t){this.x=t.x,this.y=t.y;for(var e=t.wallStarts.length-1;e>=0;e--)t.wallStarts[e].setStart(this);for(var e=t.wallEnds.length-1;e>=0;e--)t.wallEnds[e].setEnd(this);t.removeAll(),this.removeDuplicateWalls(),this.floorplan.update()},e.prototype.mergeWithIntersected=function(){for(var e=0;e<this.floorplan.getCorners().length;e++){var n=this.floorplan.getCorners()[e];if(this.distanceFromCorner(n)<o&&n!=this)return this.combineWithCorner(n),!0}for(var e=0;e<this.floorplan.getWalls().length;e++){var i=this.floorplan.getWalls()[e];if(this.distanceFromWall(i)<o&&!this.isWallConnected(i)){var r=t.Core.Utils.closestPointOnLine(this.x,this.y,i.getStart().x,i.getStart().y,i.getEnd().x,i.getEnd().y);return this.x=r.x,this.y=r.y,this.floorplan.newWall(this,i.getEnd()),i.setEnd(this),this.floorplan.update(),!0}}return!1},e.prototype.removeDuplicateWalls=function(){for(var t={},e={},o=this.wallStarts.length-1;o>=0;o--)this.wallStarts[o].getEnd()===this?this.wallStarts[o].remove():this.wallStarts[o].getEnd().id in t?this.wallStarts[o].remove():t[this.wallStarts[o].getEnd().id]=!0;for(var o=this.wallEnds.length-1;o>=0;o--)this.wallEnds[o].getStart()===this?this.wallEnds[o].remove():this.wallEnds[o].getStart().id in e?this.wallEnds[o].remove():e[this.wallEnds[o].getStart().id]=!0},e}();e.Corner=n}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=function(){function e(t,e,o){this.room=t,this.wall=e,this.front=o,this.plane=null,this.interiorTransform=new THREE.Matrix4,this.invInteriorTransform=new THREE.Matrix4,this.exteriorTransform=new THREE.Matrix4,this.invExteriorTransform=new THREE.Matrix4,this.redrawCallbacks=$.Callbacks(),this.generatePlane=function(){function t(t){return new THREE.Vector3(t.x,0,t.y)}var e=t(this.interiorStart()),o=t(this.interiorEnd()),n=o.clone();n.y=this.wall.height;var i=e.clone();i.y=this.wall.height;var r=new THREE.Geometry;r.vertices=[e,o,n,i],r.faces.push(new THREE.Face3(0,1,2)),r.faces.push(new THREE.Face3(0,2,3)),r.computeFaceNormals(),r.computeBoundingBox(),this.plane=new THREE.Mesh(r,new THREE.MeshBasicMaterial),this.plane.visible=!1,this.plane.edge=this,this.computeTransforms(this.interiorTransform,this.invInteriorTransform,this.interiorStart(),this.interiorEnd()),this.computeTransforms(this.exteriorTransform,this.invExteriorTransform,this.exteriorStart(),this.exteriorEnd())},this.front=o||!1,this.offset=e.thickness/2,this.height=e.height,this.front?this.wall.frontEdge=this:this.wall.backEdge=this}return e.prototype.getTexture=function(){return this.front?this.wall.frontTexture:this.wall.backTexture},e.prototype.setTexture=function(t,e,o){var n={url:t,stretch:e,scale:o};this.front?this.wall.frontTexture=n:this.wall.backTexture=n,this.redrawCallbacks.fire()},e.prototype.interiorDistance=function(){var e=this.interiorStart(),o=this.interiorEnd();return t.Core.Utils.distance(e.x,e.y,o.x,o.y)},e.prototype.computeTransforms=function(e,o,n,i){var r=n,s=i,a=t.Core.Utils.angle(1,0,s.x-r.x,s.y-r.y),l=new THREE.Matrix4;l.makeTranslation(-r.x,0,-r.y);var c=new THREE.Matrix4;c.makeRotationY(-a),e.multiplyMatrices(c,l),o.getInverse(e)},e.prototype.distanceTo=function(e,o){return t.Core.Utils.pointDistanceFromLine(e,o,this.interiorStart().x,this.interiorStart().y,this.interiorEnd().x,this.interiorEnd().y)},e.prototype.getStart=function(){return this.front?this.wall.getStart():this.wall.getEnd()},e.prototype.getEnd=function(){return this.front?this.wall.getEnd():this.wall.getStart()},e.prototype.getOppositeEdge=function(){return this.front?this.wall.backEdge:this.wall.frontEdge},e.prototype.interiorEnd=function(){var t=this.halfAngleVector(this,this.next);return{x:this.getEnd().x+t.x,y:this.getEnd().y+t.y}},e.prototype.interiorStart=function(){var t=this.halfAngleVector(this.prev,this);return{x:this.getStart().x+t.x,y:this.getStart().y+t.y}},e.prototype.interiorCenter=function(){return{x:(this.interiorStart().x+this.interiorEnd().x)/2,y:(this.interiorStart().y+this.interiorEnd().y)/2}},e.prototype.exteriorEnd=function(){var t=this.halfAngleVector(this,this.next);return{x:this.getEnd().x-t.x,y:this.getEnd().y-t.y}},e.prototype.exteriorStart=function(){var t=this.halfAngleVector(this.prev,this);return{x:this.getStart().x-t.x,y:this.getStart().y-t.y}},e.prototype.corners=function(){return[this.interiorStart(),this.interiorEnd(),this.exteriorEnd(),this.exteriorStart()]},e.prototype.halfAngleVector=function(e,o){if(e)var n=e.getStart().x,i=e.getStart().y,r=e.getEnd().x,s=e.getEnd().y;else var n=o.getStart().x-(o.getEnd().x-o.getStart().x),i=o.getStart().y-(o.getEnd().y-o.getStart().y),r=o.getStart().x,s=o.getStart().y;if(o)var a=o.getStart().x,l=o.getStart().y,c=o.getEnd().x,h=o.getEnd().y;else var a=e.getEnd().x,l=e.getEnd().y,c=e.getEnd().x+(e.getEnd().x-e.getStart().x),h=e.getEnd().y+(e.getEnd().y-e.getStart().y);var u=t.Core.Utils.angle2pi(n-r,i-s,c-r,h-s),d=Math.cos(u/2),f=Math.sin(u/2),p=c-a,m=h-l,E=p*d-m*f,v=p*f+m*d,g=t.Core.Utils.distance(0,0,E,v),y=this.offset/f,w=y/g,x={x:E*w,y:v*w};return x},e}();e.HalfEdge=o}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o={url:"static/rooms/textures/wallmap.png",stretch:!0,scale:0},n=function(){function e(e,n){this.start=e,this.end=n,this.frontEdge=null,this.backEdge=null,this.orphan=!1,this.items=[],this.onItems=[],this.frontTexture=o,this.backTexture=o,this.thickness=t.Core.Configuration.getNumericValue(t.Core.configWallThickness),this.height=t.Core.Configuration.getNumericValue(t.Core.configWallHeight),this.moved_callbacks=$.Callbacks(),this.deleted_callbacks=$.Callbacks(),this.action_callbacks=$.Callbacks(),this.id=this.getUuid(),this.start.attachStart(this),this.end.attachEnd(this)}return e.prototype.getUuid=function(){return[this.start.id,this.end.id].join()},e.prototype.resetFrontBack=function(){this.frontEdge=null,this.backEdge=null,this.orphan=!1},e.prototype.snapToAxis=function(t){this.start.snapToAxis(t),this.end.snapToAxis(t)},e.prototype.fireOnMove=function(t){this.moved_callbacks.add(t)},e.prototype.fireOnDelete=function(t){this.deleted_callbacks.add(t)},e.prototype.dontFireOnDelete=function(t){this.deleted_callbacks.remove(t)},e.prototype.fireOnAction=function(t){this.action_callbacks.add(t)},e.prototype.fireAction=function(t){this.action_callbacks.fire(t)},e.prototype.relativeMove=function(t,e){this.start.relativeMove(t,e),this.end.relativeMove(t,e)},e.prototype.fireMoved=function(){this.moved_callbacks.fire()},e.prototype.fireRedraw=function(){this.frontEdge&&this.frontEdge.redrawCallbacks.fire(),this.backEdge&&this.backEdge.redrawCallbacks.fire()},e.prototype.getStart=function(){return this.start},e.prototype.getEnd=function(){return this.end},e.prototype.getStartX=function(){return this.start.getX()},e.prototype.getEndX=function(){return this.end.getX()},e.prototype.getStartY=function(){return this.start.getY()},e.prototype.getEndY=function(){return this.end.getY()},e.prototype.remove=function(){this.start.detachWall(this),this.end.detachWall(this),this.deleted_callbacks.fire(this)},e.prototype.setStart=function(t){this.start.detachWall(this),t.attachStart(this),this.start=t,this.fireMoved()},e.prototype.setEnd=function(t){this.end.detachWall(this),t.attachEnd(this),this.end=t,this.fireMoved()},e.prototype.distanceFrom=function(e,o){return t.Core.Utils.pointDistanceFromLine(e,o,this.getStartX(),this.getStartY(),this.getEndX(),this.getEndY())},e.prototype.oppositeCorner=function(t){return this.start===t?this.end:this.end===t?this.start:void console.log("Wall does not connect to corner")},e}();e.Wall=n}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o={url:"static/rooms/textures/hardwood.png",scale:400},n=function(){function n(t,e){this.floorplan=t,this.corners=e,this.interiorCorners=[],this.edgePointer=null,this.floorPlane=null,this.customTexture=!1,this.floorChangeCallbacks=$.Callbacks(),this.updateWalls(),this.updateInteriorCorners(),this.generatePlane()}return n.prototype.getUuid=function(){var e=t.Core.Utils.map(this.corners,function(t){return t.id});return e.sort(),e.join()},n.prototype.fireOnFloorChange=function(t){this.floorChangeCallbacks.add(t)},n.prototype.getTexture=function(){var t=this.getUuid(),e=this.floorplan.getFloorTexture(t);return e||o},n.prototype.setTexture=function(t,e,o){var n=this.getUuid();this.floorplan.setFloorTexture(n,t,o),this.floorChangeCallbacks.fire()},n.prototype.generatePlane=function(){var t=[];this.interiorCorners.forEach(function(e){t.push(new THREE.Vector2(e.x,e.y))});var e=new THREE.Shape(t),o=new THREE.ShapeGeometry(e);this.floorPlane=new THREE.Mesh(o,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})),this.floorPlane.visible=!1,this.floorPlane.rotation.set(Math.PI/2,0,0),this.floorPlane.room=this},n.prototype.cycleIndex=function(t){return 0>t?t+=this.corners.length:t%this.corners.length},n.prototype.updateInteriorCorners=function(){for(var t=this.edgePointer;;){if(this.interiorCorners.push(t.interiorStart()),t.generatePlane(),t.next===this.edgePointer)break;t=t.next}},n.prototype.updateWalls=function(){for(var t=null,o=null,n=0;n<this.corners.length;n++){var i=this.corners[n],r=this.corners[(n+1)%this.corners.length],s=i.wallTo(r),a=i.wallFrom(r);if(s)var l=new e.HalfEdge(this,s,!0);else if(a)var l=new e.HalfEdge(this,a,!1);else console.log("corners arent connected by a wall, uh oh");0==n?o=l:(l.prev=t,t.next=l,n+1==this.corners.length&&(o.prev=l,l.next=o)),t=l}this.edgePointer=o},n}();e.Room=n}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=10,n=function(){function n(){this.walls=[],this.corners=[],this.rooms=[],this.new_wall_callbacks=$.Callbacks(),this.new_corner_callbacks=$.Callbacks(),this.redraw_callbacks=$.Callbacks(),this.updated_rooms=$.Callbacks(),this.roomLoadedCallbacks=$.Callbacks(),this.floorTextures={}}return n.prototype.wallEdges=function(){var t=[];return this.walls.forEach(function(e){e.frontEdge&&t.push(e.frontEdge),e.backEdge&&t.push(e.backEdge)}),t},n.prototype.wallEdgePlanes=function(){var t=[];return this.walls.forEach(function(e){e.frontEdge&&t.push(e.frontEdge.plane),e.backEdge&&t.push(e.backEdge.plane)}),t},n.prototype.floorPlanes=function(){return t.Core.Utils.map(this.rooms,function(t){return t.floorPlane})},n.prototype.fireOnNewWall=function(t){this.new_wall_callbacks.add(t)},n.prototype.fireOnNewCorner=function(t){this.new_corner_callbacks.add(t)},n.prototype.fireOnRedraw=function(t){this.redraw_callbacks.add(t)},n.prototype.fireOnUpdatedRooms=function(t){this.updated_rooms.add(t)},n.prototype.newWall=function(t,o){var n=new e.Wall(t,o);this.walls.push(n);var i=this;return n.fireOnDelete(function(){i.removeWall(n)}),this.new_wall_callbacks.fire(n),this.update(),n},n.prototype.removeWall=function(e){t.Core.Utils.removeValue(this.walls,e),this.update()},n.prototype.newCorner=function(t,o,n){var i=this,r=new e.Corner(this,t,o,n);return this.corners.push(r),r.fireOnDelete(function(){i.removeCorner}),this.new_corner_callbacks.fire(r),r},n.prototype.removeCorner=function(e){t.Core.Utils.removeValue(this.corners,e)},n.prototype.getWalls=function(){return this.walls},n.prototype.getCorners=function(){return this.corners},n.prototype.getRooms=function(){return this.rooms},n.prototype.overlappedCorner=function(t,e,n){n=n||o;for(var i=0;i<this.corners.length;i++)if(this.corners[i].distanceFrom(t,e)<n)return this.corners[i];return null},n.prototype.overlappedWall=function(t,e,n){n=n||o;for(var i=0;i<this.walls.length;i++)if(this.walls[i].distanceFrom(t,e)<n)return this.walls[i];return null},n.prototype.saveFloorplan=function(){var t={corners:{},walls:[],wallTextures:[],floorTextures:{},newFloorTextures:{}};return this.corners.forEach(function(e){t.corners[e.id]={x:e.x,y:e.y}}),this.walls.forEach(function(e){t.walls.push({corner1:e.getStart().id,corner2:e.getEnd().id,frontTexture:e.frontTexture,backTexture:e.backTexture})}),t.newFloorTextures=this.floorTextures,t},n.prototype.loadFloorplan=function(t){this.reset();var e={};if(null!=t&&"corners"in t&&"walls"in t){for(var o in t.corners){var n=t.corners[o];e[o]=this.newCorner(n.x,n.y,o)}var i=this;t.walls.forEach(function(t){var o=i.newWall(e[t.corner1],e[t.corner2]);t.frontTexture&&(o.frontTexture=t.frontTexture),t.backTexture&&(o.backTexture=t.backTexture)}),"newFloorTextures"in t&&(this.floorTextures=t.newFloorTextures),this.update(),this.roomLoadedCallbacks.fire()}},n.prototype.getFloorTexture=function(t){return t in this.floorTextures?this.floorTextures[t]:null},n.prototype.setFloorTexture=function(t,e,o){this.floorTextures[t]={url:e,scale:o}},n.prototype.updateFloorTextures=function(){var e=t.Core.Utils.map(this.rooms,function(t){return t.getUuid()});for(var o in this.floorTextures)t.Core.Utils.hasValue(e,o)||delete this.floorTextures[o]},n.prototype.reset=function(){var t=this.corners.slice(0),e=this.walls.slice(0);t.forEach(function(t){t.remove()}),e.forEach(function(t){t.remove()}),this.corners=[],this.walls=[]},n.prototype.update=function(){this.walls.forEach(function(t){t.resetFrontBack()});var t=this.findRooms(this.corners);this.rooms=[];var o=this;t.forEach(function(t){o.rooms.push(new e.Room(o,t))}),this.assignOrphanEdges(),this.updateFloorTextures(),this.updated_rooms.fire()},n.prototype.getCenter=function(){return this.getDimensions(!0)},n.prototype.getSize=function(){return this.getDimensions(!1)},n.prototype.getDimensions=function(t){t=t||!1;var e=1/0,o=-1/0,n=1/0,i=-1/0;this.corners.forEach(function(t){t.x<e&&(e=t.x),t.x>o&&(o=t.x),t.y<n&&(n=t.y),t.y>i&&(i=t.y)});var r;return r=1/0==e||o==-1/0||1/0==n||i==-1/0?new THREE.Vector3:t?new THREE.Vector3(.5*(e+o),0,.5*(n+i)):new THREE.Vector3(o-e,0,i-n)},n.prototype.assignOrphanEdges=function(){var t=[];this.walls.forEach(function(o){if(!o.backEdge&&!o.frontEdge){o.orphan=!0;var n=new e.HalfEdge(null,o,!1);n.generatePlane();var i=new e.HalfEdge(null,o,!0);i.generatePlane(),t.push(o)}})},n.prototype.findRooms=function(e){function o(e,o,n){var i=t.Core.Utils.angle2pi(e.x-o.x,e.y-o.y,n.x-o.x,n.y-o.y);return i}function n(e){for(var o=[],n={},i=function(t){return t.id},r="-",s=0;s<e.length;s++){for(var a=!0,l=e[s],c=0;c<l.length;c++){var h=t.Core.Utils.cycle(l,c),u=t.Core.Utils.map(h,i).join(r);n.hasOwnProperty(u)&&(a=!1)}a&&(o.push(e[s]),n[u]=!0)}return o}function i(t,e){var n=[],i={corner:e,previousCorners:[t]},r={};for(r[t.id]=!0;i;){var s=i.corner;if(r[s.id]=!0,i.corner===t&&s!==e)return i.previousCorners;for(var a=[],l=i.corner.adjacentCorners(),c=0;c<l.length;c++){var h=l[c];h.id in r&&(h!==t||s===e)||a.push(h)}var u=i.previousCorners.slice(0);if(u.push(s),a.length>1){var d=i.previousCorners[i.previousCorners.length-1];a.sort(function(t,e){return o(d,s,e)-o(d,s,t)})}a.length>0&&a.forEach(function(t){n.push({corner:t,previousCorners:u})}),i=n.pop()}return[]}var r=[];e.forEach(function(t){t.adjacentCorners().forEach(function(e){r.push(i(t,e))})});var s=n(r),a=t.Core.Utils.removeIf(s,t.Core.Utils.isClockwise);return a},n}();e.Floorplan=n}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=function(e){function o(t,o,n,i,r,s,a){e.call(this,t,o,n,i,r,s,a)}return __extends(o,e),o.prototype.placeInRoom=function(){if(!this.position_set){var t=this.model.floorplan.getCenter();this.position.x=t.x,this.position.z=t.z,this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)}},o.prototype.resized=function(){this.position.y=this.halfSize.y},o.prototype.moveToPosition=function(t){return this.isValidPosition(t)?(this.hideError(),t.y=this.position.y,this.position.copy(t),void 0):void this.showError(t)},o.prototype.isValidPosition=function(e){for(var o=this.getCorners("x","z",e),n=this.model.floorplan.getRooms(),i=!1,r=0;r<n.length;r++)t.Core.Utils.pointInPolygon(e.x,e.z,n[r].interiorCorners)&&!t.Core.Utils.polygonPolygonIntersect(o,n[r].interiorCorners)&&(i=!0);return i?!0:!1},o}(e.Item);e.FloorItem=o}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=function(e){function o(t,o,n,i,r,s,a){e.call(this,t,o,n,i,r,s,a),this.currentWallEdge=null,this.refVec=new THREE.Vector2(0,1),this.wallOffsetScalar=0,this.sizeX=0,this.sizeY=0,this.addToWall=!1,this.boundToFloor=!1,this.frontVisible=!1,this.backVisible=!1,this.allowRotate=!1}return __extends(o,e),o.prototype.closestWallEdge=function(){var t=this.model.floorplan.wallEdges(),e=null,o=null,n=this.position.x,i=this.position.z;return t.forEach(function(t){var r=t.distanceTo(n,i);(null===o||o>r)&&(o=r,e=t)}),e},o.prototype.removed=function(){null!=this.currentWallEdge&&this.addToWall&&(t.Core.Utils.removeValue(this.currentWallEdge.wall.items,this),this.redrawWall())},o.prototype.redrawWall=function(){this.addToWall&&this.currentWallEdge.wall.fireRedraw()},o.prototype.updateEdgeVisibility=function(t,e){e?this.frontVisible=t:this.backVisible=t,this.visible=this.frontVisible||this.backVisible},o.prototype.updateSize=function(){this.wallOffsetScalar=(this.geometry.boundingBox.max.z-this.geometry.boundingBox.min.z)*this.scale.z/2,this.sizeX=(this.geometry.boundingBox.max.x-this.geometry.boundingBox.min.x)*this.scale.x,this.sizeY=(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y},o.prototype.resized=function(){this.boundToFloor&&(this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y+.01),this.updateSize(),this.redrawWall()},o.prototype.placeInRoom=function(){var t=this.closestWallEdge();if(this.changeWallEdge(t),this.updateSize(),!this.position_set){var e=t.interiorCenter(),o=new THREE.Vector3(e.x,t.wall.height/2,e.y);this.boundMove(o),this.position.copy(o),this.redrawWall()}},o.prototype.moveToPosition=function(t,e){this.changeWallEdge(e.object.edge),this.boundMove(t),this.position.copy(t),this.redrawWall()},o.prototype.getWallOffset=function(){return this.wallOffsetScalar},o.prototype.changeWallEdge=function(e){null!=this.currentWallEdge&&(this.addToWall?(t.Core.Utils.removeValue(this.currentWallEdge.wall.items,this),this.redrawWall()):t.Core.Utils.removeValue(this.currentWallEdge.wall.onItems,this)),null!=this.currentWallEdge&&this.currentWallEdge.wall.dontFireOnDelete(this.remove.bind(this)),e.wall.fireOnDelete(this.remove.bind(this));var o=new THREE.Vector2,n=e.plane.geometry.faces[0].normal;o.x=n.x,o.y=n.z;var i=t.Core.Utils.angle(this.refVec.x,this.refVec.y,o.x,o.y);this.rotation.y=i,this.currentWallEdge=e,this.addToWall?(e.wall.items.push(this),this.redrawWall()):e.wall.onItems.push(this)},o.prototype.customIntersectionPlanes=function(){return this.model.floorplan.wallEdgePlanes()},o.prototype.boundMove=function(t){var e=1,o=this.currentWallEdge;t.applyMatrix4(o.interiorTransform),t.x<this.sizeX/2+e?t.x=this.sizeX/2+e:t.x>o.interiorDistance()-this.sizeX/2-e&&(t.x=o.interiorDistance()-this.sizeX/2-e),this.boundToFloor?t.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y+.01:t.y<this.sizeY/2+e?t.y=this.sizeY/2+e:t.y>o.height-this.sizeY/2-e&&(t.y=o.height-this.sizeY/2-e),t.z=this.getWallOffset(),t.applyMatrix4(o.invInteriorTransform)},o}(e.Item);e.WallItem=o}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(t){function e(e,o,n,i,r,s,a){t.call(this,e,o,n,i,r,s,a),this.addToWall=!0}return __extends(e,t),e.prototype.getWallOffset=function(){return-this.currentWallEdge.offset+.5},e}(t.WallItem);t.InWallItem=e}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(t){function e(e,o,n,i,r,s,a){t.call(this,e,o,n,i,r,s,a),this.boundToFloor=!0}return __extends(e,t),e}(t.InWallItem);t.InWallFloorItem=e}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(t){function e(e,o,n,i,r,s,a){t.call(this,e,o,n,i,r,s,a),this.obstructFloorMoves=!1,this.receiveShadow=!0}return __extends(e,t),e}(t.FloorItem);t.OnFloorItem=e}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(t){function e(e,o,n,i,r,s,a){t.call(this,e,o,n,i,r,s,a),this.boundToFloor=!0}return __extends(e,t),e}(t.WallItem);t.WallFloorItem=e}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e={1:t.FloorItem,2:t.WallItem,3:t.InWallItem,7:t.InWallFloorItem,8:t.OnFloorItem,9:t.WallFloorItem},o=function(){function t(){}return t.getClass=function(t){return e[t]},t}();t.Factory=o}(e=t.Items||(t.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){var o=function(){function e(t,e){this.model=t,this.textureDir=e,this.items=[],this.needsUpdate=!1,this.itemLoadingCallbacks=$.Callbacks(),this.itemLoadedCallbacks=$.Callbacks(),this.itemRemovedCallbacks=$.Callbacks(),this.scene=new THREE.Scene,this.loader=new THREE.JSONLoader,this.loader.crossOrigin=""
}return e.prototype.add=function(t){this.scene.add(t)},e.prototype.remove=function(e){this.scene.remove(e),t.Core.Utils.removeValue(this.items,e)},e.prototype.getScene=function(){return this.scene},e.prototype.getItems=function(){return this.items},e.prototype.itemCount=function(){return this.items.length},e.prototype.clearItems=function(){var t=(this.items,this);this.items.forEach(function(e){t.removeItem(e,!0)}),this.items=[]},e.prototype.removeItem=function(e,o){o=o||!1,this.itemRemovedCallbacks.fire(e),e.removed(),this.scene.remove(e),o||t.Core.Utils.removeValue(this.items,e)},e.prototype.addItem=function(e,o,n,i,r,s,a){e=e||1;var l=this,c=function(o,c){var h=new(t.Items.Factory.getClass(e))(l.model,n,o,new THREE.MeshFaceMaterial(c),i,r,s);h.fixed=a||!1,l.items.push(h),l.add(h),h.initObject(),l.itemLoadedCallbacks.fire(h)};this.itemLoadingCallbacks.fire(),this.loader.load(o,c,void 0)},e}();e.Scene=o}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(){function e(e){this.roomLoadingCallbacks=$.Callbacks(),this.roomLoadedCallbacks=$.Callbacks(),this.roomSavedCallbacks=$.Callbacks(),this.roomDeletedCallbacks=$.Callbacks(),this.floorplan=new t.Floorplan,this.scene=new t.Scene(this,e)}return e.prototype.loadSerialized=function(t){this.roomLoadingCallbacks.fire();var e=JSON.parse(t);this.newRoom(e.floorplan,e.items),this.roomLoadedCallbacks.fire()},e.prototype.exportSerialized=function(){for(var t=[],e=this.scene.getItems(),o=0;o<e.length;o++){var n=e[o];t[o]={item_name:n.metadata.itemName,item_type:n.metadata.itemType,model_url:n.metadata.modelUrl,xpos:n.position.x,ypos:n.position.y,zpos:n.position.z,rotation:n.rotation.y,scale_x:n.scale.x,scale_y:n.scale.y,scale_z:n.scale.z,fixed:n.fixed}}var i={floorplan:this.floorplan.saveFloorplan(),items:t};return JSON.stringify(i)},e.prototype.newRoom=function(t,e){var o=this;this.scene.clearItems(),this.floorplan.loadFloorplan(t),e.forEach(function(t){var e=new THREE.Vector3(t.xpos,t.ypos,t.zpos),n={itemName:t.item_name,resizable:t.resizable,itemType:t.item_type,modelUrl:t.model_url},i=new THREE.Vector3(t.scale_x,t.scale_y,t.scale_z);o.scene.addItem(t.item_type,t.model_url,n,e,t.rotation,i,t.fixed)})},e}();t.Model=e}(e=t.Model||(t.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){e.floorplannerModes={MOVE:0,DRAW:1,DELETE:2};var o=20,n=1,i="#f1f1f1",r="#f9f9f9",s=5,a=7,l="#dddddd",c="#008cba",h="#888888",u="#008cba",d=1,f="#ff0000",p=0,m=7,E="#cccccc",v="#008cba",g=function(){function g(t,e,o){this.floorplan=t,this.viewmodel=e,this.canvas=o,this.canvasElement=document.getElementById(o),this.context=this.canvasElement.getContext("2d");var n=this;$(window).resize(function(){n.handleWindowResize()}),this.handleWindowResize()}return g.prototype.handleWindowResize=function(){var t=$("#"+this.canvas),e=t.parent();t.height(e.innerHeight()),t.width(e.innerWidth()),this.canvasElement.height=e.innerHeight(),this.canvasElement.width=e.innerWidth(),this.draw()},g.prototype.draw=function(){var t=this;this.context.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.drawGrid(),this.floorplan.getRooms().forEach(function(e){t.drawRoom(e)}),this.floorplan.getWalls().forEach(function(e){t.drawWall(e)}),this.floorplan.getCorners().forEach(function(e){t.drawCorner(e)}),this.viewmodel.mode==e.floorplannerModes.DRAW&&this.drawTarget(this.viewmodel.targetX,this.viewmodel.targetY,this.viewmodel.lastNode),this.floorplan.getWalls().forEach(function(e){t.drawWallLabels(e)})},g.prototype.drawWallLabels=function(t){t.backEdge&&t.frontEdge?this.drawEdgeLabel(t.backEdge.interiorDistance<t.frontEdge.interiorDistance?t.backEdge:t.frontEdge):t.backEdge?this.drawEdgeLabel(t.backEdge):t.frontEdge&&this.drawEdgeLabel(t.frontEdge)},g.prototype.drawWall=function(t){var o=t===this.viewmodel.activeWall,n=l;o&&this.viewmodel.mode==e.floorplannerModes.DELETE?n=f:o&&(n=c),this.drawLine(this.viewmodel.convertX(t.getStartX()),this.viewmodel.convertY(t.getStartY()),this.viewmodel.convertX(t.getEndX()),this.viewmodel.convertY(t.getEndY()),o?a:s,n),!o&&t.frontEdge&&this.drawEdge(t.frontEdge,o),!o&&t.backEdge&&this.drawEdge(t.backEdge,o)},g.prototype.drawEdgeLabel=function(e){var o=e.interiorCenter(),n=e.interiorDistance();60>n||(this.context.font="normal 12px Arial",this.context.fillStyle="#000000",this.context.textBaseline="middle",this.context.textAlign="center",this.context.strokeStyle="#ffffff",this.context.lineWidth=4,this.context.strokeText(t.Core.Dimensioning.cmToMeasure(n),this.viewmodel.convertX(o.x),this.viewmodel.convertY(o.y)),this.context.fillText(t.Core.Dimensioning.cmToMeasure(n),this.viewmodel.convertX(o.x),this.viewmodel.convertY(o.y)))},g.prototype.drawEdge=function(o,n){var i=h;n&&this.viewmodel.mode==e.floorplannerModes.DELETE?i=f:n&&(i=u);var r=o.corners(),s=this;this.drawPolygon(t.Core.Utils.map(r,function(t){return s.viewmodel.convertX(t.x)}),t.Core.Utils.map(r,function(t){return s.viewmodel.convertY(t.y)}),!1,null,!0,i,d)},g.prototype.drawRoom=function(e){var o=this;this.drawPolygon(t.Core.Utils.map(e.corners,function(t){return o.viewmodel.convertX(t.x)}),t.Core.Utils.map(e.corners,function(t){return o.viewmodel.convertY(t.y)}),!0,r)},g.prototype.drawCorner=function(t){var o=t===this.viewmodel.activeCorner,n=E;o&&this.viewmodel.mode==e.floorplannerModes.DELETE?n=f:o&&(n=v),this.drawCircle(this.viewmodel.convertX(t.x),this.viewmodel.convertY(t.y),o?m:p,n)},g.prototype.drawTarget=function(t,e,o){this.drawCircle(this.viewmodel.convertX(t),this.viewmodel.convertY(e),m,v),this.viewmodel.lastNode&&this.drawLine(this.viewmodel.convertX(o.x),this.viewmodel.convertY(o.y),this.viewmodel.convertX(t),this.viewmodel.convertY(e),a,c)},g.prototype.drawLine=function(t,e,o,n,i,r){this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(o,n),this.context.lineWidth=i,this.context.strokeStyle=r,this.context.stroke()},g.prototype.drawPolygon=function(t,e,o,n,i,r,s){o=o||!1,i=i||!1,this.context.beginPath(),this.context.moveTo(t[0],e[0]);for(var a=1;a<t.length;a++)this.context.lineTo(t[a],e[a]);this.context.closePath(),o&&(this.context.fillStyle=n,this.context.fill()),i&&(this.context.lineWidth=s,this.context.strokeStyle=r,this.context.stroke())},g.prototype.drawCircle=function(t,e,o,n){this.context.beginPath(),this.context.arc(t,e,o,0,2*Math.PI,!1),this.context.fillStyle=n,this.context.fill()},g.prototype.calculateGridOffset=function(t){return 0>t?(t-o/2)%o+o/2:(t+o/2)%o-o/2},g.prototype.drawGrid=function(){for(var t=this.calculateGridOffset(-this.viewmodel.originX),e=this.calculateGridOffset(-this.viewmodel.originY),r=this.canvasElement.width,s=this.canvasElement.height,a=0;r/o>=a;a++)this.drawLine(o*a+t,0,o*a+t,s,n,i);for(var l=0;s/o>=l;l++)this.drawLine(0,o*l+e,r,o*l+e,n,i)},g}();e.FloorplannerView=g}(e=t.Floorplanner||(t.Floorplanner={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=25,o=function(){function o(e,o){this.floorplan=o,this.mode=0,this.activeWall=null,this.activeCorner=null,this.originX=0,this.originY=0,this.targetX=0,this.targetY=0,this.lastNode=null,this.modeResetCallbacks=$.Callbacks(),this.mouseDown=!1,this.mouseMoved=!1,this.mouseX=0,this.mouseY=0,this.rawMouseX=0,this.rawMouseY=0,this.lastX=0,this.lastY=0,this.canvasElement=$("#"+e),this.view=new t.FloorplannerView(this.floorplan,this,e);var n=30.48,i=15;this.cmPerPixel=n*(1/i),this.pixelsPerCm=1/this.cmPerPixel,this.wallWidth=10*this.pixelsPerCm,this.setMode(t.floorplannerModes.MOVE);var r=this;this.canvasElement.mousedown(function(){r.mousedown()}),this.canvasElement.mousemove(function(t){r.mousemove(t)}),this.canvasElement.mouseup(function(){r.mouseup()}),this.canvasElement.mouseleave(function(){r.mouseleave()}),$(document).keyup(function(t){27==t.keyCode&&r.escapeKey()}),o.roomLoadedCallbacks.add(function(){r.reset()})}return o.prototype.escapeKey=function(){this.setMode(t.floorplannerModes.MOVE)},o.prototype.updateTarget=function(){this.mode==t.floorplannerModes.DRAW&&this.lastNode?(this.targetX=Math.abs(this.mouseX-this.lastNode.x)<e?this.lastNode.x:this.mouseX,this.targetY=Math.abs(this.mouseY-this.lastNode.y)<e?this.lastNode.y:this.mouseY):(this.targetX=this.mouseX,this.targetY=this.mouseY),this.view.draw()},o.prototype.mousedown=function(){this.mouseDown=!0,this.mouseMoved=!1,this.lastX=this.rawMouseX,this.lastY=this.rawMouseY,this.mode==t.floorplannerModes.DELETE&&(this.activeCorner?this.activeCorner.removeAll():this.activeWall?this.activeWall.remove():this.setMode(t.floorplannerModes.MOVE))},o.prototype.mousemove=function(o){if(this.mouseMoved=!0,this.rawMouseX=o.clientX,this.rawMouseY=o.clientY,this.mouseX=(o.clientX-this.canvasElement.offset().left)*this.cmPerPixel+this.originX*this.cmPerPixel,this.mouseY=(o.clientY-this.canvasElement.offset().top)*this.cmPerPixel+this.originY*this.cmPerPixel,(this.mode==t.floorplannerModes.DRAW||this.mode==t.floorplannerModes.MOVE&&this.mouseDown)&&this.updateTarget(),this.mode!=t.floorplannerModes.DRAW&&!this.mouseDown){var n=this.floorplan.overlappedCorner(this.mouseX,this.mouseY),i=this.floorplan.overlappedWall(this.mouseX,this.mouseY),r=!1;n!=this.activeCorner&&(this.activeCorner=n,r=!0),null==this.activeCorner?i!=this.activeWall&&(this.activeWall=i,r=!0):this.activeWall=null,r&&this.view.draw()}!this.mouseDown||this.activeCorner||this.activeWall||(this.originX+=this.lastX-this.rawMouseX,this.originY+=this.lastY-this.rawMouseY,this.lastX=this.rawMouseX,this.lastY=this.rawMouseY,this.view.draw()),this.mode==t.floorplannerModes.MOVE&&this.mouseDown&&(this.activeCorner?(this.activeCorner.move(this.mouseX,this.mouseY),this.activeCorner.snapToAxis(e)):this.activeWall&&(this.activeWall.relativeMove((this.rawMouseX-this.lastX)*this.cmPerPixel,(this.rawMouseY-this.lastY)*this.cmPerPixel),this.activeWall.snapToAxis(e),this.lastX=this.rawMouseX,this.lastY=this.rawMouseY),this.view.draw())},o.prototype.mouseup=function(){if(this.mouseDown=!1,this.mode==t.floorplannerModes.DRAW&&!this.mouseMoved){var e=this.floorplan.newCorner(this.targetX,this.targetY);null!=this.lastNode&&this.floorplan.newWall(this.lastNode,e),e.mergeWithIntersected()&&null!=this.lastNode&&this.setMode(t.floorplannerModes.MOVE),this.lastNode=e}},o.prototype.mouseleave=function(){this.mouseDown=!1},o.prototype.reset=function(){this.resizeView(),this.setMode(t.floorplannerModes.MOVE),this.resetOrigin(),this.view.draw()},o.prototype.resizeView=function(){this.view.handleWindowResize()},o.prototype.setMode=function(t){this.lastNode=null,this.mode=t,this.modeResetCallbacks.fire(t),this.updateTarget()},o.prototype.resetOrigin=function(){var t=this.canvasElement.innerWidth()/2,e=this.canvasElement.innerHeight()/2,o=this.floorplan.getCenter();this.originX=o.x*this.pixelsPerCm-t,this.originY=o.z*this.pixelsPerCm-e},o.prototype.convertX=function(t){return(t-this.originX*this.cmPerPixel)*this.pixelsPerCm},o.prototype.convertY=function(t){return(t-this.originY*this.cmPerPixel)*this.pixelsPerCm},o}();t.Floorplanner=o}(e=t.Floorplanner||(t.Floorplanner={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){e.Controller=function(e,o,n,i,r,s){function a(){i.mousedown(m),i.mouseup(E),i.mousemove(p),M=new THREE.Vector2,k.itemRemovedCallbacks.add(u),k.itemLoadedCallbacks.add(l),d()}function l(t){if(!t.position_set){C.setSelectedObject(t),v(W.DRAGGING);var o=t.position.clone();o.y=0;var n=e.projectVector(o);c(n)}t.position_set=!0}function c(t){t=t||M;var e=C.itemIntersection(M,D);e&&D.clickPressed(e)}function h(t){t=t||M;var e=C.itemIntersection(M,D);e&&(C.isRotating()?D.rotate(e):D.clickDragged(e))}function u(t){t===D&&(D.setUnselected(),D.mouseOff(),C.setSelectedObject(null))}function d(){var t=1e4;R=new THREE.Mesh(new THREE.PlaneGeometry(t,t),new THREE.MeshBasicMaterial),R.rotation.x=-Math.PI/2,R.visible=!1,k.add(R)}function f(){if(O==W.UNSELECTED&&null==S){var t=o.floorplan.wallEdgePlanes(),n=C.getIntersections(M,t,!0);if(n.length>0){var i=n[0].object.edge;return void e.wallClicked.fire(i)}var r=o.floorplan.floorPlanes(),s=C.getIntersections(M,r,!1);if(s.length>0){var a=s[0].object.room;return void e.floorClicked.fire(a)}e.nothingClicked.fire()}}function p(t){if(C.enabled)switch(t.preventDefault(),I=!0,M.x=t.clientX,M.y=t.clientY,H||w(),O){case W.UNSELECTED:b();break;case W.SELECTED:b();break;case W.DRAGGING:case W.ROTATING:case W.ROTATING_FREE:h(),s.update(),C.needsUpdate=!0}}function m(t){if(C.enabled)switch(t.preventDefault(),I=!1,H=!0,O){case W.SELECTED:B?v(W.ROTATING):null!=P&&(C.setSelectedObject(P),P.fixed||v(W.DRAGGING));break;case W.UNSELECTED:null!=P&&(C.setSelectedObject(P),P.fixed||v(W.DRAGGING));break;case W.DRAGGING:case W.ROTATING:break;case W.ROTATING_FREE:v(W.SELECTED)}}function E(){if(C.enabled)switch(H=!1,O){case W.DRAGGING:D.clickReleased(),v(W.SELECTED);break;case W.ROTATING:v(I?W.SELECTED:W.ROTATING_FREE);break;case W.UNSELECTED:I||f();break;case W.SELECTED:null!=P||I||(v(W.UNSELECTED),f());break;case W.ROTATING_FREE:}}function v(t){t!=O&&(y(O),g(t)),O=t,s.setRotating(C.isRotating())}function g(t){switch(t){case W.UNSELECTED:C.setSelectedObject(null);case W.SELECTED:r.enabled=!0;break;case W.ROTATING:case W.ROTATING_FREE:r.enabled=!1;break;case W.DRAGGING:e.setCursorStyle("move"),c(),r.enabled=!1}}function y(t){switch(t){case W.UNSELECTED:case W.SELECTED:break;case W.DRAGGING:e.setCursorStyle(S?"pointer":"auto");break;case W.ROTATING:case W.ROTATING_FREE:}}function w(){var t=s.getObject();if(null!=t){var e=C.getIntersections(M,t,!1,!1,!0);if(e.length>0)return B=!0,s.setMouseover(!0),void(P=null)}B=!1,s.setMouseover(!1);var n=o.scene.getItems(),i=C.getIntersections(M,n,!1,!0);P=i.length>0?i[0].object:null}function x(t){var o=new THREE.Vector2;return o.x=(t.x-e.widthMargin)/(window.innerWidth-e.widthMargin)*2-1,o.y=2*-((t.y-e.heightMargin)/(window.innerHeight-e.heightMargin))+1,o}function T(t){var e=x(t),o=new THREE.Vector3(e.x,e.y,.5);return o.unproject(n),o}function b(){null!=P?null!=S?S!==P&&(S.mouseOff(),S=P,S.mouseOver(),C.needsUpdate=!0):(S=P,S.mouseOver(),e.setCursorStyle("pointer"),C.needsUpdate=!0):null!=S&&(S.mouseOff(),e.setCursorStyle("auto"),S=null,C.needsUpdate=!0)}var C=this;this.enabled=!0;var R,M,P,S,D,e=e,o=o,k=o.scene,i=i,n=n,r=r,s=s,H=!1,I=!1,B=!1,W={UNSELECTED:0,SELECTED:1,DRAGGING:2,ROTATING:3,ROTATING_FREE:4,PANNING:5},O=W.UNSELECTED;this.needsUpdate=!0,this.isRotating=function(){return O==W.ROTATING||O==W.ROTATING_FREE},this.selectedObject=function(){return D},this.itemIntersection=function(t,e){var o=e.customIntersectionPlanes(),n=null;return n=o&&o.length>0?this.getIntersections(t,o,!0):this.getIntersections(t,R),n.length>0?n[0]:null},this.getIntersections=function(e,o,i,r,s,a){var l=T(e);r=r||!1,i=i||!1,s=s||!1,a=a||20;var c=l.sub(n.position).normalize(),h=new THREE.Raycaster(n.position,c);h.linePrecision=a;var u;return u=o instanceof Array?h.intersectObjects(o,s):h.intersectObject(o,s),r&&(u=t.Core.Utils.removeIf(u,function(t){return!t.object.visible})),i&&(u=t.Core.Utils.removeIf(u,function(t){var e=t.face.normal.dot(c);return e>0})),u},this.setSelectedObject=function(t){O===W.UNSELECTED&&v(W.SELECTED),null!=D&&D.setUnselected(),null!=t?(D=t,D.setSelected(),e.itemSelectedCallbacks.fire(t)):(D=null,e.itemUnselectedCallbacks.fire()),this.needsUpdate=!0},a()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Floor=function(t,e){function o(){r.room.fireOnFloorChange(n),s=i()}function n(){r.removeFromScene(),s=i(),r.addToScene()}function i(){var t=r.room.getTexture(),e=THREE.ImageUtils.loadTexture(t.url);e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat.set(1,1);var o=new THREE.MeshPhongMaterial({map:e,side:THREE.DoubleSide,color:13421772,specular:657930}),n=t.scale,i=[];r.room.interiorCorners.forEach(function(t){i.push(new THREE.Vector2(t.x/n,t.y/n))});var s=new THREE.Shape(i),a=new THREE.ShapeGeometry(s),l=new THREE.Mesh(a,o);return l.rotation.set(Math.PI/2,0,0),l.scale.set(n,n,n),l.receiveShadow=!0,l.castShadow=!1,l}var r=this;this.room=e;var t=t,s=null;o(),this.addToScene=function(){t.add(s),t.add(e.floorPlane)},this.removeFromScene=function(){t.remove(s),t.remove(e.floorPlane)}}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(e){e.Edge=function(e,o,n){function i(){o.redrawCallbacks.add(r),n.cameraMovedCallbacks.add(l),h(),u(),a()}function r(){s(),h(),u(),a()}function s(){w.forEach(function(t){e.remove(t)}),x.forEach(function(t){e.remove(t)}),w=[],x=[]}function a(){w.forEach(function(t){e.add(t)}),x.forEach(function(t){e.add(t)}),l()}function l(){var t=o.interiorStart(),e=o.interiorEnd(),i=e.x-t.x,r=e.y-t.y,s=new THREE.Vector3(-r,0,i);s.normalize();var a=n.object.position.clone(),l=new THREE.Vector3((t.x+e.x)/2,0,(t.y+e.y)/2),h=a.sub(l).normalize(),u=s.dot(h);v.visible=u>=0,w.forEach(function(t){t.visible=v.visible}),c()}function c(){g.items.forEach(function(t){t.updateEdgeVisibility(v.visible,y)}),g.onItems.forEach(function(t){t.updateEdgeVisibility(v.visible,y)})}function h(t){t=t||function(){e.needsUpdate=!0};var n=o.getTexture(),i=n.stretch,r=n.url,s=n.scale;if(T=THREE.ImageUtils.loadTexture(r,null,t),!i){var a=g.height,l=o.interiorDistance();T.wrapT=THREE.RepeatWrapping,T.wrapS=THREE.RepeatWrapping,T.repeat.set(l/s,a/s),T.needsUpdate=!0}}function u(){var t=new THREE.MeshBasicMaterial({color:16777215,side:THREE.FrontSide,map:T}),e=new THREE.MeshBasicMaterial({color:b,side:THREE.DoubleSide});w.push(d(o.exteriorStart(),o.exteriorEnd(),o.exteriorTransform,o.invExteriorTransform,e)),w.push(d(o.interiorStart(),o.interiorEnd(),o.interiorTransform,o.invInteriorTransform,t)),x.push(p(o,0,THREE.BackSide,R)),w.push(p(o,g.height,THREE.DoubleSide,b)),w.push(f(o.interiorStart(),o.exteriorStart(),g.height,C)),w.push(f(o.interiorEnd(),o.exteriorEnd(),g.height,C))}function d(e,o,n,i,r){function s(e){var o=t.Core.Utils.distance(a.x,a.z,e.x,e.z)/p,n=e.y/m;return new THREE.Vector2(o,n)}var a=E(e),l=E(o),c=l.clone();c.y=g.height;var h=a.clone();h.y=g.height;var u=[a.clone(),l.clone(),c.clone(),h.clone()];u.forEach(function(t){t.applyMatrix4(n)});var d=new THREE.Shape([new THREE.Vector2(u[0].x,u[0].y),new THREE.Vector2(u[1].x,u[1].y),new THREE.Vector2(u[2].x,u[2].y),new THREE.Vector2(u[3].x,u[3].y)]);g.items.forEach(function(t){var e=t.position.clone();e.applyMatrix4(n);var o=t.halfSize,i=o.clone().multiplyScalar(-1),r=o.clone();i.add(e),r.add(e);var s=[new THREE.Vector2(i.x,i.y),new THREE.Vector2(r.x,i.y),new THREE.Vector2(r.x,r.y),new THREE.Vector2(i.x,r.y)];d.holes.push(new THREE.Path(s))});var f=new THREE.ShapeGeometry(d);f.vertices.forEach(function(t){t.applyMatrix4(i)});var p=t.Core.Utils.distance(a.x,a.z,l.x,l.z),m=g.height;f.faceVertexUvs[0]=[],f.faces.forEach(function(t){var e=f.vertices[t.a],o=f.vertices[t.b],n=f.vertices[t.c];f.faceVertexUvs[0].push([s(e),s(o),s(n)])}),f.faceVertexUvs[1]=f.faceVertexUvs[0],f.computeFaceNormals(),f.computeVertexNormals();var v=new THREE.Mesh(f,r);return v}function f(t,e,o,n){var i=[E(t),E(e),E(e,o),E(t,o)],r=new THREE.Geometry;i.forEach(function(t){r.vertices.push(t)}),r.faces.push(new THREE.Face3(0,1,2)),r.faces.push(new THREE.Face3(0,2,3));var s=new THREE.MeshBasicMaterial({color:n,side:THREE.DoubleSide}),a=new THREE.Mesh(r,s);return a}function p(t,e,o,n){var i=[m(t.exteriorStart()),m(t.exteriorEnd()),m(t.interiorEnd()),m(t.interiorStart())],r=new THREE.MeshBasicMaterial({color:n,side:o}),s=new THREE.Shape(i),a=new THREE.ShapeGeometry(s),l=new THREE.Mesh(a,r);return l.rotation.set(Math.PI/2,0,0),l.position.y=e,l}function m(t){return new THREE.Vector2(t.x,t.y)}function E(t,e){return e=e||0,new THREE.Vector3(t.x,e,t.y)}var v=this,e=e,o=o,n=n,g=o.wall,y=o.front,w=[],x=[],T=null,b=(THREE.ImageUtils.loadTexture("static/rooms/textures/walllightmap.png"),14540253),C=13421772,R=14540253;this.visible=!1,this.remove=function(){o.redrawCallbacks.remove(r),n.cameraMovedCallbacks.remove(l),s()},i()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Floorplan=function(e,o,n){function i(){r.floors.forEach(function(t){t.removeFromScene()}),r.edges.forEach(function(t){t.remove()}),r.floors=[],r.edges=[],r.floorplan.getRooms().forEach(function(o){var n=new t.Floor(e,o);r.floors.push(n),n.addToScene()}),r.floorplan.wallEdges().forEach(function(o){var n=new t.Edge(e,o,r.controls);r.edges.push(n)})}var r=this;this.scene=e,this.floorplan=o,this.controls=n,this.floors=[],this.edges=[],o.fireOnUpdatedRooms(i)}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Lights=function(t,e){function o(){var o=new THREE.HemisphereLight(16777215,8947848,1.1);o.position.set(0,s,0),t.add(o),i=new THREE.DirectionalLight(16777215,0),i.color.setHSL(1,1,.1),i.castShadow=!0,i.shadowMapWidth=1024,i.shadowMapHeight=1024,i.shadowCameraFar=s+r,i.shadowBias=-1e-4,i.shadowDarkness=.2,i.visible=!0,i.shadowCameraVisible=!1,t.add(i),t.add(i.target),e.fireOnUpdatedRooms(n)}function n(){var t=e.getSize(),o=(Math.max(t.z,t.x)+r)/2,n=e.getCenter(),a=new THREE.Vector3(n.x,s,n.z);i.position.copy(a),i.target.position.copy(n),i.shadowCameraLeft=-o,i.shadowCameraRight=o,i.shadowCameraTop=o,i.shadowCameraBottom=-o,i.shadowCamera&&(i.shadowCamera.left=i.shadowCameraLeft,i.shadowCamera.right=i.shadowCameraRight,i.shadowCamera.top=i.shadowCameraTop,i.shadowCamera.bottom=i.shadowCameraBottom,i.shadowCamera.updateProjectionMatrix())}var i,t=t,e=e,r=1,s=300;this.getDirLight=function(){return i},o()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Skybox=function(t){function e(){var e={topColor:{type:"c",value:new THREE.Color(o)},bottomColor:{type:"c",value:new THREE.Color(n)},offset:{type:"f",value:i}},h=new THREE.SphereGeometry(r,s,a),u=new THREE.ShaderMaterial({vertexShader:l,fragmentShader:c,uniforms:e,side:THREE.BackSide}),d=new THREE.Mesh(h,u);t.add(d)}var t=t,o=0,n=1974051,i=500,r=4e3,s=32,a=15,l="varying vec3 vWorldPosition;\nvoid main() {\n  vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n  vWorldPosition = worldPosition.xyz;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",c="uniform vec3 topColor;\nuniform vec3 bottomColor;\nuniform float offset;\nvarying vec3 vWorldPosition;\nvoid main() {\n  float h = normalize( vWorldPosition + offset ).y;\n  gl_FragColor = vec4( mix( bottomColor, topColor, (h + 1.0) / 2.0), 1.0 );\n}";e()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Controls=function(t,e){function o(){return 2*Math.PI/60/60*d.autoRotateSpeed}function n(){return Math.pow(.95,d.zoomSpeed)}function i(t){if(d.enabled!==!1){if(t.preventDefault(),0===t.button){if(d.noRotate===!0)return;S=P.ROTATE,p.set(t.clientX,t.clientY)}else if(1===t.button){if(d.noZoom===!0)return;S=P.DOLLY,w.set(t.clientX,t.clientY)}else if(2===t.button){if(d.noPan===!0)return;S=P.PAN,v.set(t.clientX,t.clientY)}d.domElement.addEventListener("mousemove",r,!1),d.domElement.addEventListener("mouseup",s,!1)}}function r(t){if(d.enabled!==!1){t.preventDefault();var e=d.domElement===document?d.domElement.body:d.domElement;if(S===P.ROTATE){if(d.noRotate===!0)return;m.set(t.clientX,t.clientY),E.subVectors(m,p),d.rotateLeft(2*Math.PI*E.x/e.clientWidth*d.rotateSpeed),d.rotateUp(2*Math.PI*E.y/e.clientHeight*d.rotateSpeed),p.copy(m)}else if(S===P.DOLLY){if(d.noZoom===!0)return;x.set(t.clientX,t.clientY),T.subVectors(x,w),T.y>0?d.dollyIn():d.dollyOut(),w.copy(x)}else if(S===P.PAN){if(d.noPan===!0)return;g.set(t.clientX,t.clientY),y.subVectors(g,v),d.pan(y),v.copy(g)}d.update()}}function s(){d.enabled!==!1&&(d.domElement.removeEventListener("mousemove",r,!1),d.domElement.removeEventListener("mouseup",s,!1),S=P.NONE)}function a(t){if(d.enabled!==!1&&d.noZoom!==!0){var e=0;t.wheelDelta?e=t.wheelDelta:t.detail&&(e=-t.detail),e>0?d.dollyOut():d.dollyIn(),d.update()}}function l(t){if(d.enabled!==!1&&d.noKeys!==!0&&d.noPan!==!0)switch(t.keyCode){case d.keys.UP:d.pan(new THREE.Vector2(0,d.keyPanSpeed));break;case d.keys.BOTTOM:d.pan(new THREE.Vector2(0,-d.keyPanSpeed));break;case d.keys.LEFT:d.pan(new THREE.Vector2(d.keyPanSpeed,0));break;case d.keys.RIGHT:d.pan(new THREE.Vector2(-d.keyPanSpeed,0))}}function c(t){if(d.enabled!==!1)switch(t.touches.length){case 1:if(d.noRotate===!0)return;S=P.TOUCH_ROTATE,p.set(t.touches[0].pageX,t.touches[0].pageY);break;case 2:if(d.noZoom===!0)return;S=P.TOUCH_DOLLY;var e=t.touches[0].pageX-t.touches[1].pageX,o=t.touches[0].pageY-t.touches[1].pageY,n=Math.sqrt(e*e+o*o);w.set(0,n);break;case 3:if(d.noPan===!0)return;S=P.TOUCH_PAN,v.set(t.touches[0].pageX,t.touches[0].pageY);break;default:S=P.NONE}}function h(t){if(d.enabled!==!1){t.preventDefault(),t.stopPropagation();var e=d.domElement===document?d.domElement.body:d.domElement;switch(t.touches.length){case 1:if(d.noRotate===!0)return;if(S!==P.TOUCH_ROTATE)return;m.set(t.touches[0].pageX,t.touches[0].pageY),E.subVectors(m,p),d.rotateLeft(2*Math.PI*E.x/e.clientWidth*d.rotateSpeed),d.rotateUp(2*Math.PI*E.y/e.clientHeight*d.rotateSpeed),p.copy(m);break;case 2:if(d.noZoom===!0)return;if(S!==P.TOUCH_DOLLY)return;var o=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(o*o+n*n);x.set(0,i),T.subVectors(x,w),T.y>0?d.dollyOut():d.dollyIn(),w.copy(x);break;case 3:if(d.noPan===!0)return;if(S!==P.TOUCH_PAN)return;g.set(t.touches[0].pageX,t.touches[0].pageY),y.subVectors(g,v),d.pan(y),v.copy(g);break;default:S=P.NONE}}}function u(){d.enabled!==!1&&(S=P.NONE)}this.object=t,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1500,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=40,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI/2,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.cameraMovedCallbacks=$.Callbacks(),this.needsUpdate=!0;var d=this,f=1e-6,p=new THREE.Vector2,m=new THREE.Vector2,E=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector2,x=new THREE.Vector2,T=new THREE.Vector2,b=0,C=0,R=1,M=new THREE.Vector3,P={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},S=P.NONE;this.controlsActive=function(){return S===P.NONE},this.setPan=function(t){M=t},this.panTo=function(t){var e=new THREE.Vector3(t.x,d.target.y,t.z),o=d.target.clone().sub(e);M.sub(o),d.update()},this.rotateLeft=function(t){void 0===t&&(t=o()),C-=t},this.rotateUp=function(t){void 0===t&&(t=o()),b-=t},this.panLeft=function(t){var e=new THREE.Vector3,o=this.object.matrix.elements;e.set(o[0],0,o[2]),e.normalize(),e.multiplyScalar(-t),M.add(e)},this.panUp=function(t){var e=new THREE.Vector3,o=this.object.matrix.elements;e.set(o[4],0,o[6]),e.normalize(),e.multiplyScalar(t),M.add(e)},this.pan=function(t){var e=d.domElement===document?d.domElement.body:d.domElement;if(void 0!==d.object.fov){var o=d.object.position,n=o.clone().sub(d.target),i=n.length();i*=Math.tan(d.object.fov/2*Math.PI/180),d.panLeft(2*t.x*i/e.clientHeight),d.panUp(2*t.y*i/e.clientHeight)}else void 0!==d.object.top?(d.panLeft(t.x*(d.object.right-d.object.left)/e.clientWidth),d.panUp(t.y*(d.object.top-d.object.bottom)/e.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.");d.update()},this.panXY=function(t,e){d.pan(new THREE.Vector2(t,e))},this.dollyIn=function(t){void 0===t&&(t=n()),R/=t},this.dollyOut=function(t){void 0===t&&(t=n()),R*=t},this.update=function(){var t=this.object.position,e=t.clone().sub(this.target),n=Math.atan2(e.x,e.z),i=Math.atan2(Math.sqrt(e.x*e.x+e.z*e.z),e.y);this.autoRotate&&this.rotateLeft(o()),n+=C,i+=b,i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i)),i=Math.max(f,Math.min(Math.PI-f,i));var r=e.length()*R;r=Math.max(this.minDistance,Math.min(this.maxDistance,r)),this.target.add(M),e.x=r*Math.sin(i)*Math.sin(n),e.y=r*Math.cos(i),e.z=r*Math.sin(i)*Math.cos(n),t.copy(this.target).add(e),this.object.lookAt(this.target),C=0,b=0,R=1,M.set(0,0,0),this.cameraMovedCallbacks.fire(),this.needsUpdate=!0},this.domElement.addEventListener("contextmenu",function(t){t.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),this.domElement.addEventListener("touchstart",c,!1),this.domElement.addEventListener("touchend",u,!1),this.domElement.addEventListener("touchmove",h,!1),window.addEventListener("keydown",l,!1)}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.HUD=function(t){function e(){t.itemSelectedCallbacks.add(n),t.itemUnselectedCallbacks.add(i)}function o(){m=null,T&&(p.remove(T),T=null)}function n(t){m!=t&&(o(),t.allowRotate&&!t.fixed&&(m=t,T=d(m),p.add(T)))}function i(){o()}function r(){T&&T.children.forEach(function(t){t.material.color.set(s())}),t.needsUpdate()}function s(){return v||E?x:w}function a(t){var e=new THREE.Geometry;return e.vertices.push(new THREE.Vector3(0,0,0),l(t)),e}function l(t){var e=new THREE.Vector3(0,0,Math.max(t.halfSize.x,t.halfSize.z)+1.4+y);return e}function c(){var t=new THREE.LineBasicMaterial({color:s(),linewidth:3});return t}function h(t){var e=new THREE.CylinderGeometry(5,0,10),o=new THREE.MeshBasicMaterial({color:s()}),n=new THREE.Mesh(e,o);return n.position.copy(l(t)),n.rotation.x=-Math.PI/2,n}function u(){var t=new THREE.SphereGeometry(4,16,16),e=new THREE.MeshBasicMaterial({color:s()}),o=new THREE.Mesh(t,e);return o}function d(t){var e=new THREE.Object3D,o=new THREE.Line(a(t),c(f.rotating),THREE.LinePieces),n=h(t),i=u(t);return e.add(o),e.add(n),e.add(i),e.rotation.y=t.rotation.y,e.position.x=t.position.x,e.position.z=t.position.z,e.position.y=g,e}var f=this,t=t,p=new THREE.Scene,m=null,E=!1,v=!1,g=5,y=20,w="#ffffff",x="#f1c40f",T=null;this.getScene=function(){return p},this.getObject=function(){return T},this.setRotating=function(t){E=t,r()},this.setMouseover=function(t){v=t,r()},this.update=function(){T&&(T.rotation.y=m.rotation.y,T.position.x=m.position.x,T.position.z=m.position.z)},e()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){t.Main=function(e,o,n,i){function r(){THREE.ImageUtils.crossOrigin="",p=h.element.get(0),m=new THREE.PerspectiveCamera(45,1,1,1e4),E=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),E.autoClear=!1,E.shadowMapEnabled=!0,E.shadowMapSoft=!0,E.shadowMapType=THREE.PCFSoftShadowMap;new t.Skybox(f);h.controls=new t.Controls(m,p),y=new t.HUD(h),v=new t.Controller(h,e,m,h.element,h.controls,y),p.appendChild(E.domElement),h.updateWindowSize(),u.resize&&$(window).resize(h.updateWindowSize),h.centerCamera(),e.floorplan.fireOnUpdatedRooms(h.centerCamera);new t.Lights(f,e.floorplan);g=new t.Floorplan(f,e.floorplan,h.controls),c(),h.element.mouseenter(function(){T=!0}).mouseleave(function(){T=!1}).click(function(){b=!0})}function s(){if(u.spin&&!T&&!b){var t=2*Math.PI*u.spinSpeed*(Date.now()-x);h.controls.rotateLeft(t),h.controls.update()}}function a(){return h.controls.needsUpdate||v.needsUpdate||w||e.scene.needsUpdate?(h.controls.needsUpdate=!1,v.needsUpdate=!1,w=!1,e.scene.needsUpdate=!1,!0):!1}function l(){s(),a()&&(E.clear(),E.render(f.getScene(),m),E.clearDepth(),E.render(y.getScene(),m)),x=Date.now()}function c(){var t=50;setTimeout(function(){requestAnimationFrame(c)},t),l()}var h=this,u={resize:!0,pushHref:!1,spin:!0,spinSpeed:2e-5,clickPan:!0,canMoveFixedItems:!1};for(var d in u)u.hasOwnProperty(d)&&i.hasOwnProperty(d)&&(u[d]=i[d]);var f=e.scene,e=e;this.element=$(o);var p,m,E;this.controls;var v,g,y,w=!1,x=Date.now(),T=!1,b=!1;this.heightMargin,this.widthMargin,this.elementHeight,this.elementWidth,this.itemSelectedCallbacks=$.Callbacks(),this.itemUnselectedCallbacks=$.Callbacks(),this.wallClicked=$.Callbacks(),this.floorClicked=$.Callbacks(),this.nothingClicked=$.Callbacks(),this.dataUrl=function(){var t=E.domElement.toDataURL("image/png");
return t},this.stopSpin=function(){b=!0},this.options=function(){return u},this.getModel=function(){return e},this.getScene=function(){return f},this.getController=function(){return v},this.getCamera=function(){return m},this.needsUpdate=function(){w=!0},this.rotatePressed=function(){v.rotatePressed()},this.rotateReleased=function(){v.rotateReleased()},this.setCursorStyle=function(t){p.style.cursor=t},this.updateWindowSize=function(){h.heightMargin=h.element.offset().top,h.widthMargin=h.element.offset().left,h.elementWidth=h.element.innerWidth(),h.elementHeight=u.resize?window.innerHeight-h.heightMargin:h.element.innerHeight(),m.aspect=h.elementWidth/h.elementHeight,m.updateProjectionMatrix(),E.setSize(h.elementWidth,h.elementHeight),w=!0},this.centerCamera=function(){var t=150,o=e.floorplan.getCenter();o.y=t,h.controls.target=o;var n=1.5*e.floorplan.getSize().z,i=o.clone().add(new THREE.Vector3(0,n,n));m.position.copy(i),h.controls.update()},this.projectVector=function(t,e){e=e||!1;var o=h.elementWidth/2,n=h.elementHeight/2,i=new THREE.Vector3;i.copy(t),i.project(m);var r=new THREE.Vector2;return r.x=i.x*o+o,r.y=-(i.y*n)+n,e||(r.x+=h.widthMargin,r.y+=h.heightMargin),r},r()}}(e=t.Three||(t.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e=function(){function e(e){this.model=new t.Model.Model(e.textureDir),this.three=new t.Three.Main(this.model,e.threeElement,e.threeCanvasElement,{}),e.widget?this.three.getController().enabled=!1:this.floorplanner=new t.Floorplanner.Floorplanner(e.floorplannerElement,this.model.floorplan)}return e}();t.Blueprint3d=e}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){function e(e,o){return t.logContext===n.All||t.logContext==e||o===i.Warning||o===i.Error||o===i.Fatal}function o(t,o,n){if(e(t,o)!==!1){var r="";switch(o){case i.Information:r="[INFO_] ";break;case i.Warning:r="[WARNG] ";break;case i.Error:r="[ERROR] ";break;case i.Fatal:r="[FATAL] ";break;case i.Debug:r="[DEBUG] "}console.log(r+n)}}!function(t){t[t.None=0]="None",t[t.All=1]="All",t[t.Interaction2d=2]="Interaction2d",t[t.Item=3]="Item",t[t.Wall=4]="Wall",t[t.Room=5]="Room"}(t.ELogContext||(t.ELogContext={}));var n=t.ELogContext;!function(t){t[t.Information=0]="Information",t[t.Warning=1]="Warning",t[t.Error=2]="Error",t[t.Fatal=3]="Fatal",t[t.Debug=4]="Debug"}(t.ELogLevel||(t.ELogLevel={}));var i=t.ELogLevel;t.logContext=n.None,t.isLogging=e,t.log=o}(e=t.Core||(t.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(t){var e;!function(t){var e=function(){function t(){}return t.getInformalVersion=function(){return"1.0 Beta 1"},t.getTechnicalVersion=function(){return"1.0.0.1"},t}();t.Version=e}(e=t.Core||(t.Core={}))}(BP3D||(BP3D={})),console.log("Blueprint3D "+BP3D.Core.Version.getInformalVersion()+" ("+BP3D.Core.Version.getTechnicalVersion()+")"); export default BP3D;
